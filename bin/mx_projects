#!/bin/bash

# Update existing folders?

scriptname=$0   # $0 is the name of the program
Root="$HOME/code"
# Apps=(abacus alfred amigo ballista batcave bob bullseye bunyan dispatch dunaway firefly grunt hulk longbow monty newman persona ranger relay sherlock synchronicity wormhole)
Apps=(abacus batcave alfred relay)
App=''

# -f Force removing of directory and re-clone
# '-a app' run on just a single app
FORCE=false
SKIP=false
UPDATE=false

# Print usage help
function usage() {
   cat <<EOF
Usage: $scriptname [-a app_name] [-f] [-h]
   -a   Run for a single app
   -f   Force (delete and re-create)
   -h   displays basic help
EOF
   exit 0
}

# Get arguments
while getopts ":a:fhs" opt; do
   case $opt in

   a )  Apps=($OPTARG) ;;
   f )  FORCE=true ;;
   s )  SKIP=true ;;
   h )  usage ;;
   \?)  usage ;;
   esac
done

shift $(($OPTIND - 1))

fix_rbenv() {
  # https://stackoverflow.com/questions/17550903/why-do-i-get-a-permission-denied-error-while-installing-a-gem
  # brew update && upgrade
  # brew doctor
  # brew uninstall ruby
  # brew uninstall rbenv
  # brew install rbenv
  # rbenv install 2.3.1
  # sudo chown -R richardfrost ~/.rbenv
  cd "$Root/$App"
  rbenv local
  gem install bundler
  rbenv rehash
  bundle
}

clone_app_repo() {
  if [ -d "$Root" ]; then
    cd "$Root"
    if [ ! -d "$App" ] || $1; then
      rm -rf "$Root/$App"
      git clone "git@git.moneydesktop.com:dev/${App}.git"
    fi
  else
    echo "Code root dir doesn't exist: $Root"
    return 1
  fi
}

get_stable() {
  if [ -d "$Root/$App" ]; then
    cd "$Root/$App"
    git checkout stable
    git pull
  else
    echo "Can't get stable: $Root/$App"
    return 1
  fi
}

update_ruby_and_gems() {
  if [ -d "$Root/$App" ]; then
    cd "$Root/$App"
    rbenv install -s
    bundler_installed=$(gem list bundler -i)
    if [ $bundler_installed == 'false' ]; then
      gem install bundler -N
    fi
    rbenv rehash
    bundle
  else
    echo "Can't update gems: $Root/$App"
    return 1
  fi
}

for App in "${Apps[@]}"
do
  if [ "$App" ]; then
    printf "\n\033[0;34m[${App}]\033[0m\n"
    clone_app_repo $FORCE && get_stable && update_ruby_and_gems

    # sed -i -e "s/gem \"atlas\"/gem \"atlas\", :git => 'git@git\.moneydesktop\.com:dev\/atlas\.git', :branch => 'nobroadcast'/g" Gemfile
    # bundle update protobuf
    # git reset --hard
    # git commit -m "Use atlas nobroadcast branch"
    # git push origin se-prod
  fi
done
cd $Root
