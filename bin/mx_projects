#!/bin/bash

# Update existing folders?

scriptname=$0   # $0 is the name of the program
root="$HOME/code"
apps=(abacus alfred amigo ballista batcave bob bullseye bunyan dispatch dunaway firefly grunt hulk longbow monty newman persona ranger relay sherlock synchronicity wormhole)
orgs=(dev IT-Infrastructure change-control)
force=false
skip=false
update=false

# Print usage help
function usage() {
   cat <<EOF
Usage: $scriptname [-a app_name] [-f] [-h]
   -a   Run for a single app
   -f   Force (delete and re-create)
   -h   displays basic help
EOF
   exit 0
}

# Get arguments
while getopts ":a:fhs" opt; do
   case $opt in
   a )  apps=($OPTARG) ;;
   f )  force=true ;;
   s )  skip=true ;;
   h )  usage ;;
   \?)  usage ;;
   esac
done

shift $(($OPTIND - 1))

fix_rbenv() {
  # https://stackoverflow.com/questions/17550903/why-do-i-get-a-permission-denied-error-while-installing-a-gem
  # brew update && upgrade
  # brew doctor
  # brew uninstall ruby
  # brew uninstall rbenv
  # brew install rbenv
  # rbenv install 2.3.1
  # sudo chown -R richardfrost ~/.rbenv
  cd "$root/$app"
  rbenv local
  gem install bundler
  rbenv rehash
  bundle
}

clone_app_repo() {
  force=$1
  if [ -d "$root" ]; then
    cd "$root"
    if [ ! -d "$app" ] || $force; then
      rm -rf "$root/$app"
      for i in "${orgs[@]}"; do
        git clone "git@git.moneydesktop.com:${i}/${app}.git"
        if [ $? == 0 ]; then break; fi
      done
    fi
  else
    echo "Code root dir doesn't exist: $root"
    return 1
  fi
}

get_stable() {
  if [ -d "$root/$app" ]; then
    cd "$root/$app"
    git checkout stable
    git pull
  else
    echo "Can't get stable: $root/$app"
    return 1
  fi
}

update_ruby_and_gems() {
  if [ -d "$root/$app" ]; then
    if [ -f "$root/$app/Gemfile" ]; then
      cd "$root/$app"
      rbenv install -s
      bundler_installed=$(gem list bundler -i)
      if [ $bundler_installed == 'false' ]; then
        gem install bundler -N
      fi
      rbenv rehash
      bundle
    fi
  else
    echo "Can't update gems; directory not found: $root/$app"
    return 1
  fi
}

for app in "${apps[@]}"
do
  if [ "$app" ]; then
    printf "\n\033[0;34m[${app}]\033[0m\n"
    clone_app_repo $force && get_stable && update_ruby_and_gems

    # sed -i -e "s/gem \"atlas\"/gem \"atlas\", :git => 'git@git\.moneydesktop\.com:dev\/atlas\.git', :branch => 'nobroadcast'/g" Gemfile
    # bundle update protobuf
    # git reset --hard
    # git commit -m "Use atlas nobroadcast branch"
    # git push origin se-prod
  fi
done
cd $root
